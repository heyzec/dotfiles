# ${{}} regular shell command (drop to terminal)
# &{{}} async shell command
# %{{}} piping shell command (output to statline)

# use ctpv to preview files, including images
# on wayland terminals that support sixel, add "set chafasixel" to ~/.config/ctpv/config
set sixel true
set previewer ctpv
set cleaner ctpvclear

# == A custom 'delete' command ==
# lf by default doesn't handle spaces well, and the project wiki snippets don't factor this
# https://github.com/gokcehan/lf/issues/47
# - lf's filesep by default is the newline character
# - Our solution uses xargs as intermediate to avoid spaces in filename being splitted
#   limitation: This breaks when files contain newline char instead
# - lf doesn't support using the null char as a filesep, mainly due to
#   POSIX disallowing null char in variables
# - Test cases: touch 'a a' 'b b' 'c\nc' "d"$'\n'"d"
#   - delete a, b, c individually, then all of them together
#   - file d will fail as expected
# - Ensure changes remain GNU and BSD compatible
cmd delete ${{
	set -f
	printf "$fx\n"
	printf "delete? [y/n]"
	read ans
	# Use xargs to avoid spaces in filename being splitted
	# Limitation: This breaks when files contain newline char instead
	[ "$ans" != "y" ] && return
	printf "%s" "$fx" | awk '{ printf "%s%c", $0, 0 }' | xargs --null rm -rf
}}

cmd open ${{
	case $(file --mime-type $f -b) in
		text/*|application/javascript|application/json|application/xml|inode/x-empty)
			$EDITOR "$fx"
			;;
		*)
			$OPENER "$fx"
			;;
	esac
}}

cmd set-prompt &{{
	fmt="$(starship prompt | sed -e '2!d' -e 's/%[{}]//g')"
	lf -remote "send $id set promptfmt \"$fmt\""
}}
set-prompt

# Integrate with zoxide
cmd z %{{
	result="$(zoxide query --exclude $PWD $@ | sed 's/\\/\\\\/g;s/"/\\"/g')"
	lf -remote "send $id cd \"$result\""
}}
cmd zi ${{
	result="$(zoxide query -i | sed 's/\\/\\\\/g;s/"/\\"/g')"
	lf -remote "send $id cd \"$result\""
}}

cmd on-cd &{{
	lf -remote "send set-prompt"
	zoxide add "$PWD"
}}

# Make shell cd to folder (requires config in zsh)
map Q &{{
	tmp="/tmp/LF_LAST_DIR_PATH"
	echo "$PWD" > $tmp
	lf -remote "send $id quit"
}}

# vim: set noexpandtab:
